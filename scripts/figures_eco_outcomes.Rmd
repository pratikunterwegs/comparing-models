---
editor_options: 
  chunk_output_type: console
---

# Ecological outcomes

```{r}
library(data.table)

# for plotting
library(ggplot2)
library(scico)
library(patchwork)
library(ggraph)
```

Load trait data.

```{r}
# list files
trait_data = list.files(
  "inst/data/", pattern = "trait", full.names = TRUE
)

# read files
trait_data = lapply(trait_data, fread)

# get similar columns and add social strategy
trait_data = lapply(trait_data, function(df) {
  
  # assign social strategy and dispersal
  if(!"social_strat" %in% colnames(df)) {
    df[, social_strat := "none"]
  }
  if(!"dispersal" %in% colnames(df)) {
    df[, dispersal := fifelse(type %in% c("evolved", "unevolved"), "local", "global")]
  }
  
  df[, c("intake", "energy", "assoc", "moved", "replicate",
         "social_strat", "landscape", "type", "dispersal",
         "sF", "sH", "sN")]
})

# get as bound df
trait_data = rbindlist(trait_data)

# set levels
trait_data[, type := factor(
  type, levels = c("random", "optimal", "pref2_unevolved",
                   "2pref", "unevolved", "evolved"
  )
)]

# subset data
trait_data = trait_data[landscape == "patchy" &
                          dispersal == "global" &
                          type %in% c("random", "optimal", "2pref", "evolved")]
```

```{r}
scale_prefs = function(df) {
  # get movement strategy
  df[, c("sF", "sH", "sN") := lapply(
    .SD, function(tr_) {
      tr_ / (abs(sF) + abs(sH) + abs(sN))
    }
  ), .SDcols = c("sF", "sH", "sN")][]
}
```

## Evolved traits

```{r}
strategies = trait_data[type %in% c("2pref", "unevolved", "evolved")]
strategies[type == "2pref", sN := 0]

scale_prefs(strategies)
```

## Intake

Prepare plot for intake or harvesting.

```{r}
p_intake =
  ggplot(trait_data)+
  geom_boxplot(
    aes(
      type, intake,
      fill = type
    ),
    width = 0.3,
    notch = TRUE,
    col = "grey30",
    outlier.size = 0.2,
    show.legend = TRUE
  )+
  geom_hline(
    yintercept = 40,
    col = "indianred",
    lty = 2
  )+
  scale_x_discrete(
    labels = NULL,
    name = "Movement implementation"
  )+
  scale_fill_scico_d(
    palette = "batlow",
    labels = c(
      "Random\nwalk", "Optimal\nmovement", 
      "Mechanistic\n2 cues\nG = 100",
      "Mechanistic\n3 cues\nG = 100"
    ),
    name = NULL
  )+
  theme_test()+
  theme(legend.position = "top")+
  guides(
    fill = guide_legend(
      nrow = 2
    )
  )+
  labs(
    x = NULL,
    y = "Per-capita intake"
  )
```

## Distance moved

```{r}
p_move =
  ggplot(trait_data)+
  geom_boxplot(
    aes(
      type, moved,
      fill = type
    ),
    width = 0.3,
    notch = TRUE,
    col = "grey30",
    outlier.size = 0.2,
    show.legend = TRUE
  )+
  geom_hline(
    yintercept = 200,
    col = "indianred",
    lty = 2
  )+
  scale_x_discrete(
    labels = NULL,
    name = "Movement implementation"
  )+
  scale_fill_scico_d(
    palette = "batlow",
    labels = c(
      "Random\nwalk", "Optimal\nmovement", 
      "Mechanistic\n2 cues\nG = 100",
      "Mechanistic\n3 cues\nG = 100"
    ),
    name = NULL
  )+
  theme_test()+
  theme(
    legend.position = "top"
  )+
  guides(
    fill = guide_legend(
      nrow = 2
    )
  )+
  labs(
    x = NULL,
    y = "Distance moved"
  )
```

## Associations

```{r}
p_assoc =
  ggplot(trait_data)+
  geom_boxplot(
    aes(
      type, assoc,
      fill = type
    ),
    width = 0.3,
    notch = TRUE,
    col = "grey30",
    outlier.size = 0.2,
    show.legend = TRUE
  )+
  scale_x_discrete(
    labels = NULL,
    name = "Movement implementation"
  )+
  scale_fill_scico_d(
    palette = "batlow",
    labels = c(
      "Random\nwalk", "Optimal\nmovement", 
      "Mechanistic\n2 cues\nG = 100",
      "Mechanistic\n3 cues\nG = 100"
    ),
    name = NULL
  )+
  scale_y_log10(
    labels = scales::comma
  )+
  coord_cartesian(
    ylim = c(100, NA)
  )+
  theme_test()+
  theme(
    legend.position = "top",
    axis.text.y = element_text(
      angle = 90, hjust = 0.5
    )
  )+
  guides(
    fill = guide_legend(
      nrow = 2
    )
  )+
  labs(
    x = NULL,
    y = "Associations"
  )
```

## Disease spread

Load SIR model data.

```{r}
data_sir = fread("inst/data/data_sir_thr_12.csv")

# examine only patchy landscapes with global dispersal
data_sir = data_sir[landscape == "patchy" &
                          dispersal == "global" &
                          type %in% c("random", "optimal", "2pref", "evolved")]

# set factor levels
data_sir[, type := factor(
  type, 
  levels = c("random", "optimal", "2pref", "evolved")
)]
```

```{r}
p_sir =
ggplot(data_sir[time < 5 & class == "NI"])+
stat_summary(
    aes(
      time, mean / 400,
      group = type,
      col = type
    ),
    geom = "line"
  )+
  stat_summary(
    aes(
      time, mean / 400,
      col = type,
      shape = type
    )
  )+
  scale_y_continuous(
    labels = scales::percent_format()
  )+
  scale_shape_manual(
    values = c(
      "evolved" = 16,
      "2pref" = 17,
      "optimal" = 15,
      "random" = 18
    ),
    name = NULL,
    labels = c(
      "Random\nwalk", "Optimal\nmovement", 
      "Mechanistic\n2 cues\nG = 100",
      "Mechanistic\n3 cues\nG = 100"
    )
  )+
  scale_fill_scico_d(
    palette = "batlow",
    labels = c(
      "Random\nwalk", "Optimal\nmovement", 
      "Mechanistic\n2 cues\nG = 100",
      "Mechanistic\n3 cues\nG = 100"
    ),
    name = NULL
  )+
  scale_colour_scico_d(
    palette = "batlow",
    labels = c(
      "Random\nwalk", "Optimal\nmovement", 
      "Mechanistic\n2 cues\nG = 100",
      "Mechanistic\n3 cues\nG = 100"
    ),
    name = NULL
  )+
  theme_test()+
  theme(
    legend.position = "top",
    axis.text.y = element_text(
      angle = 90, hjust = 0.5
    )
  )+
  guides(
    colour = guide_legend(
      nrow = 2
    )
  )+
  labs(
    x = "SIR model time",
    y = "Individuals infected"
  )
```

## Networks

```{r}
# read networks
network_files = list.files(
  path = "inst/data/",
  pattern = "networks",
  full.names = TRUE
)

# subset for patchy landscapes with global dispersal
network_files = network_files[grep("patchy", network_files)]#[-1]
network_files = network_files[c(1, 3, 4, 6)]

# read networks
networks = lapply(network_files, readRDS)
names(networks) = c("2pref", "evolved", "optimal", "random")
```

```{r}
threshold = 12

# process networks
networks = lapply(networks, function(le) {
  lapply(le, function(g) {
    g = g %>% 
      activate(edges) %>% 
      filter(weight > threshold) %>% 
      activate(nodes)
    
    g = g %>% 
      mutate(
        cent_degree = tidygraph::centrality_degree()
      )
  })
})
```

### Random walk network

```{r}
p_ran_net =
ggraph(
  networks[["random"]][[7]], 
  x = xn, y = yn
) +
  geom_edge_fan(
    edge_width = 0.2,
    edge_colour = "grey",
    aes(
      edge_alpha = weight
    ),
    show.legend = FALSE
  )+
  geom_node_point(
    aes(
      fill = cent_degree / 200,
      size = assoc
    ),
    shape = 21
  )+
  scale_fill_scico(
    limits = c(0, 0.5),
    labels = scales::percent,
    breaks = c(0, 0.25, 0.5),
    name = "Degree"
  )+
  scale_edge_alpha(
    range = c(0.3, 1)
  )+
  ggraph::theme_graph(
    background = "white"
  )+
  theme(
    legend.position = "top",
    legend.key.height = unit(2, "mm"),
    legend.title = element_text(vjust = 1)
  )+
  guides(
    size = "none"
  )

ggsave(
  p_ran_net,
  filename = "figures/fig_network_random.png"
)
```

### Optimal movement network

```{r}
p_opt_net =
ggraph(
  networks[["optimal"]][[7]], 
  x = xn, y = yn
) +
  geom_edge_fan(
    edge_width = 0.2,
    edge_colour = "grey",
    aes(
      edge_alpha = weight
    ),
    show.legend = FALSE
  )+
  geom_node_point(
    aes(
      fill = cent_degree / 200,
      size = assoc
    ),
    shape = 21
  )+
  scale_fill_scico(
    limits = c(0, 0.5),
    labels = scales::percent,
    breaks = c(0, 0.25, 0.5),
    name = "Degree"
  )+
  scale_edge_alpha(
    range = c(0.3, 1)
  )+
  ggraph::theme_graph(
    background = "white"
  )+
  theme(
    legend.position = "top",
    legend.key.height = unit(2, "mm"),
    legend.title = element_text(vjust = 1)
  )+
  guides(
    size = "none"
  )

ggsave(
  p_opt_net,
  filename = "figures/fig_network_optimal.png"
)
```

### Evolved network, 2 cues

```{r}
p_2pref =
ggraph(
  networks[["2pref"]][[7]], 
  x = xn, y = yn
) +
  # geom_edge_fan(
  #   edge_width = 0.2,
  #   edge_colour = "grey",
  #   aes(
  #     edge_alpha = weight
  #   ),
  #   show.legend = FALSE
  # )+
  geom_node_point(
    aes(
      fill = cent_degree / 200,
      size = assoc
    ),
    shape = 21
  )+
  scale_fill_scico(
    limits = c(0, 0.5),
    labels = scales::percent,
    breaks = c(0, 0.25, 0.5),
    name = "Degree"
  )+
  scale_edge_alpha(
    range = c(0.3, 1)
  )+
  ggraph::theme_graph(
    background = "white"
  )+
  theme(
    legend.position = "top",
    legend.key.height = unit(2, "mm"),
    legend.title = element_text(vjust = 1)
  )+
  guides(
    size = "none"
  )

ggsave(
  p_evo_net,
  filename = "figures/fig_network_evolved.png"
)
```


### Evolved network

```{r}
p_evo_net =
ggraph(
  networks[["evolved"]][[7]], 
  x = xn, y = yn
) +
  # geom_edge_fan(
  #   edge_width = 0.2,
  #   edge_colour = "grey",
  #   aes(
  #     edge_alpha = weight
  #   ),
  #   show.legend = FALSE
  # )+
  geom_node_point(
    aes(
      fill = cent_degree / 200,
      size = assoc
    ),
    shape = 21
  )+
  scale_fill_scico(
    limits = c(0, 0.5),
    labels = scales::percent,
    breaks = c(0, 0.25, 0.5),
    name = "Degree"
  )+
  scale_edge_alpha(
    range = c(0.3, 1)
  )+
  ggraph::theme_graph(
    background = "white"
  )+
  theme(
    legend.position = "top",
    legend.key.height = unit(2, "mm"),
    legend.title = element_text(vjust = 1)
  )+
  guides(
    size = "none"
  )

ggsave(
  p_evo_net,
  filename = "figures/fig_network_evolved.png"
)
```

```{r}
# wrap figures
p_nets = wrap_plots(
  p_ran_net, p_opt_net, p_2pref, p_evo_net,
  nrow = 2,
  guides = "collect"
) &
  theme(
    legend.position = "top"
  )

ggsave(
  p_nets, filename = "figures/fig_networks.png",
  height = 10, width = 10
)
```

## Make figure cs 2

```{r}
wrap_plots(
    p_intake, p_move, p_assoc, 
    nrow = 2, 
    guides = "collect"
  ) & theme(
    legend.position = "top"
  )
```
