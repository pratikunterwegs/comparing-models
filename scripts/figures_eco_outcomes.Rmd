---
editor_options: 
  chunk_output_type: console
---

# Ecological outcomes

```{r}
library(data.table)

# for plotting
library(ggplot2)
library(scico)
library(patchwork)
library(ggraph)
```

Load trait data.

```{r}
# list files
trait_data = list.files(
  "inst/data/", pattern = "trait", full.names = TRUE
)

# read files
trait_data = lapply(trait_data, fread)

# get similar columns and add social strategy
trait_data = lapply(trait_data, function(df) {
  
  # assign social strategy and dispersal
  if(!"social_strat" %in% colnames(df)) {
    df[, social_strat := "none"]
  }
  if(!"dispersal" %in% colnames(df)) {
    df[, dispersal := fifelse(type == "evolved", "local", "global")]
  }
  
  df[, c("intake", "energy", "assoc", "moved", "replicate",
         "social_strat", "landscape", "type", "dispersal")]
})

# get as bound df
trait_data = rbindlist(trait_data)

# set levels
trait_data[, type := factor(
  type, levels = c("random", "optimal", "evolved")
)]
```

## Intake

Prepare plot for intake or harvesting.

```{r}
p_intake = 
  ggplot(trait_data[landscape == "patchy" & dispersal == "global"])+
  geom_boxplot(
    aes(
      type, intake,
      fill = type
    ),
    width = 0.3,
    size = 1,
    col = "grey30",
    show.legend = T
  )+
  geom_hline(
    yintercept = 40,
    col = "indianred",
    lty = 2
  )+
  scale_x_discrete(
    labels = c(
      "Random", "Optimal", "Evolved"
    )
  )+
  scale_fill_scico_d(
    palette = "hawaii",
    name = NULL,
    labels = c(
      "Random\nwalk",
      "Optimal\nmovement",
      "Evolved\nhabitat selection"
    )
  )+
  theme_classic()+
  theme(legend.position = "top")+
  labs(
    x = NULL,
    y = "Per-capita intake"
  )
```

## Distance moved

```{r}
p_move = 
  ggplot(trait_data[landscape == "patchy" & dispersal == "global"])+
  geom_boxplot(
    aes(
      type, moved,
      fill = type
    ),
    width = 0.3,
    size = 1,
    col = "grey30",
    outlier.size = 0.2,
    show.legend = TRUE
  )+
  geom_hline(
    yintercept = 200,
    col = "indianred",
    lty = 2
  )+
  scale_x_discrete(
    labels = c(
      "Random", "Optimal", "Evolved"
    )
  )+
  scale_fill_scico_d(
    palette = "hawaii",
    name = NULL,
    labels = c(
      "Random\nwalk",
      "Optimal\nmovement",
      "Evolved\nhabitat selection"
    )
  )+
  theme_classic()+
  theme(
    legend.position = "top"
  )+
  labs(
    x = NULL,
    y = "Distance moved"
  )
```

## Associations

```{r}
p_assoc =
  ggplot(trait_data[landscape == "patchy" & dispersal == "global"])+
  geom_boxplot(
    aes(
      type, assoc,
      fill = type
    ),
    width = 0.3,
    size = 1,
    col = "grey30",
    outlier.size = 0.2,
    show.legend = TRUE
  )+
  scale_x_discrete(
    labels = c(
      "Random", "Optimal", "Evolved"
    )
  )+
  scale_y_log10(
    labels = scales::comma
  )+
  scale_fill_scico_d(
    palette = "hawaii",
    name = NULL,
    labels = c(
      "Random\nwalk",
      "Optimal\nmovement",
      "Evolved\nhabitat selection"
    )
  )+
  theme_classic()+
  theme(
    legend.position = "top",
    axis.text.y = element_text(
      angle = 90, hjust = 0.5
    )
  )+
  labs(
    x = NULL,
    y = "Associations"
  )
```

```{r}
# combine plots
p_eco =
  wrap_plots(
  p_intake, p_move, p_assoc,
  nrow = 1,
  guides = "collect"
) &
  theme(
    legend.position = "top"
  )

# write plots to file
ggsave(
  p_eco,
  filename = "figures/fig_eco_outcomes.png"
)
```


## Disease spread

Load SIR model data.

```{r}
data_sir = fread("inst/data/data_sir_thr_12.csv")

# examine only patchy landscapes with global dispersal
data_sir = data_sir[landscape == "patchy" & dispersal == "global"]

# set factor levels
data_sir[, type := factor(type, 
                              levels = c("random", "optimal", "evolved"))]
```

```{r}
p_sir = ggplot(data_sir[time < 5 & class == "NI"])+
  stat_summary(
    aes(
      time, mean / 400,
      col = type
    ),
    size = 1,
    geom = "line"
  )+
  # stat_summary(
  #   aes(
  #     time, mean / 400,
  #     col = type,
  #     shape = type
  #   )
  # )+
  scale_y_continuous(
    labels = scales::percent_format()
  )+
  scale_shape_manual(
    values = c(
      "evolved" = 0,
      "optimal" = 1,
      "random" = 2
    ),
    name = NULL,
    labels = c(
      "Random\nwalk",
      "Optimal\nmovement",
      "Evolved\nhabitat selection"
    )
  )+
  scale_colour_scico_d(
    palette = "hawaii",
    name = NULL,
    labels = c(
      "Random\nwalk",
      "Optimal\nmovement",
      "Evolved\nhabitat selection"
    )
  )+
  theme_classic()+
  theme(
    legend.position = "top",
    axis.text.y = element_text(
      angle = 90, hjust = 0.5
    )
  )+
  labs(
    x = "SIR model time",
    y = "Individuals infected"
  )

ggsave(
  p_sir, filename = "figures/fig_sir.png"
)
```

## Networks

```{r}
# read networks
network_files = list.files(
  path = "inst/data/",
  pattern = "networks",
  full.names = TRUE
)

# subset for patchy landscapes with global dispersal
network_files = network_files[grep("patchy", network_files)][-1]

# read networks
networks = lapply(network_files, readRDS)
names(networks) = c("evolved", "optimal", "random")
```

```{r}
threshold = 12

# process networks
networks = lapply(networks, function(le) {
  lapply(le, function(g) {
    g = g %>% 
      activate(edges) %>% 
      filter(weight > threshold) %>% 
      activate(nodes)
    
    g = g %>% 
      mutate(
        cent_degree = tidygraph::centrality_degree()
      )
  })
})
```

### Random walk network

```{r}
p_ran_net =
ggraph(
  networks[["random"]][[7]], 
  x = xn, y = yn
) +
  geom_edge_fan(
    edge_width = 0.2,
    edge_colour = "grey",
    aes(
      edge_alpha = weight
    ),
    show.legend = FALSE
  )+
  geom_node_point(
    aes(
      fill = cent_degree / 200,
      size = assoc
    ),
    shape = 21
  )+
  scale_fill_scico(
    palette = "hawaii",
    direction = -1,
    limits = c(0, 0.5),
    labels = scales::percent,
    breaks = c(0, 0.25, 0.5),
    name = "Degree"
  )+
  scale_edge_alpha(
    range = c(0.3, 1)
  )+
  coord_fixed(
    xlim = c(0, 30),
    ylim = c(0, 30)
  )+
  ggraph::theme_graph(
    background = "white"
  )+
  theme(
    legend.position = "top",
    legend.key.height = unit(2, "mm"),
    legend.title = element_text(vjust = 1)
  )+
  guides(
    size = "none"
  )

ggsave(
  p_ran_net,
  filename = "figures/fig_network_random.png"
)
```

### Optimal movement network

```{r}
p_opt_net =
ggraph(
  networks[["optimal"]][[7]], 
  x = xn, y = yn
) +
  geom_edge_fan(
    edge_width = 0.2,
    edge_colour = "grey",
    aes(
      edge_alpha = weight
    ),
    show.legend = FALSE
  )+
  geom_node_point(
    aes(
      fill = cent_degree / 200,
      size = assoc
    ),
    shape = 21
  )+
  scale_fill_scico(
    palette = "hawaii",
    direction = -1,
    limits = c(0, 0.5),
    labels = scales::percent,
    breaks = c(0, 0.25, 0.5),
    name = "Degree"
  )+
  scale_edge_alpha(
    range = c(0.3, 1)
  )+
  coord_fixed(
    xlim = c(0, 30),
    ylim = c(0, 30)
  )+
  ggraph::theme_graph(
    background = "white"
  )+
  theme(
    legend.position = "top",
    legend.key.height = unit(2, "mm"),
    legend.title = element_text(vjust = 1)
  )+
  guides(
    size = "none"
  )

ggsave(
  p_opt_net,
  filename = "figures/fig_network_optimal.png"
)
```

### Evolved network

```{r}
p_evo_net =
ggraph(
  networks[["evolved"]][[7]], 
  x = xn, y = yn
) +
  geom_edge_fan(
    edge_width = 0.2,
    edge_colour = "grey",
    aes(
      edge_alpha = weight
    ),
    show.legend = FALSE
  )+
  geom_node_point(
    aes(
      fill = cent_degree / 200,
      size = assoc
    ),
    shape = 21
  )+
  scale_fill_scico(
    palette = "hawaii",
    direction = -1,
    limits = c(0, 0.5),
    labels = scales::percent,
    breaks = c(0, 0.25, 0.5),
    name = "Degree"
  )+
  scale_edge_alpha(
    range = c(0.3, 1)
  )+
  coord_fixed(
    xlim = c(0, 30),
    ylim = c(0, 30)
  )+
  ggraph::theme_graph(
    background = "white"
  )+
  theme(
    legend.position = "top",
    legend.key.height = unit(2, "mm"),
    legend.title = element_text(vjust = 1)
  )+
  guides(
    size = "none"
  )

ggsave(
  p_evo_net,
  filename = "figures/fig_network_evolved.png"
)
```

```{r}
# wrap figures
p_nets = wrap_plots(
  p_ran_net, p_opt_net, p_evo_net,
  nrow = 1,
  guides = "collect"
) &
  theme(
    legend.position = "top"
  )

ggsave(
  p_nets, filename = "figures/fig_networks.png",
  height = 5, width = 15
)
```
